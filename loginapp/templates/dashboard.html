<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Control Panel</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        button { font-size: 20px; padding: 10px 30px; margin: 10px; }
        .status { font-size: 24px; margin: 20px; }
    </style>
</head>
<body>
<h1>ESP32 Water Tower Control Panel</h1>

<div class="status">
    <strong id="current_status">Current Status: {{ device.status|yesno:"ON,OFF" }}</strong>
    <p id="trigger_status">
        {% if device.last_triggered %}
            Last Triggered: {{ device.last_triggered }}
        {% else %}
            Last Triggered: N/A
        {% endif %}
    </p>
</div>

<div>
    <button id="turn-on" style="background-color: green; color: white;">Turn ON</button>
    <button id="turn-off" style="background-color: red; color: white;">Turn OFF</button>
    <p id="status-message" style="margin-top: 20px;"></p>
</div>

<script>
  const deviceUrl = "/device/status/1/";
  const csrftoken = "{{ csrf_token }}";

  document.getElementById("turn-on").addEventListener("click", function () {
    sendAction("on");
  });

  document.getElementById("turn-off").addEventListener("click", function () {
    sendAction("off");
  });

  function sendAction(action) {
    fetch(deviceUrl, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ [action]: "1" })
    })
      .then(response => response.json())
      .then(data => {
        // ✅ Display response
        document.getElementById("status-message").innerText =
          data.status === true ? "Device turned ON" : "Device turned OFF";

        // ✅ Update status info
        document.getElementById("current_status").innerText =
          "Current Status: " + (data.status ? "ON" : "OFF");

        document.getElementById("trigger_status").innerText =
          data.last_triggered
            ? `Last Triggered: ${data.last_triggered}`
            : "Last Triggered: N/A";
      })
      .catch(error => {
        document.getElementById("status-message").innerText = "Error sending request";
        console.error("Error:", error);
      });
  }
</script>
</body>
</html>
